<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs title="Glass Factory Gadget demo" description="" author="RevelDigital" background="transparent">
        <UserPref name="serverAddr" display_name="Local Server Address" datatype="string" />
        <UserPref name="month" display_name="Month" datatype="string" />
        <UserPref name="day" display_name="Day" datatype="string" />
        <UserPref name="date" display_name="Date" datatype="string" />
        <UserPref name="oven" display_name="Oven" datatype="string" />
        <UserPref name="midLabel" display_name="Mid Label" datatype="string" />
        <UserPref name="topLabel" display_name="Top Label" datatype="string" />

        
    </ModulePrefs>
    <Content type="html">
        <![CDATA[
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/Milazu/Hello-World/master/Factory1css.css">
<body>
<div class="slide">
    <div class="row centered upper">
        <div class="col-9">
            <span id="mid-label" class="bottom-aligned">Rendimiento Fabrica</span>
        </div>
          <div class="col-13">
            <span id="top-label" class="bottom-aligned">TEST</span>
        </div>

        <div class="col-3">
            <table border="0">
                <tr>
                    <td colspan="2">
                        <label class="data-label" id="date">Fecha</label>
                        <span id='fecha-field' style="font-size: 5em" class='data-field'></span>
                    </td>
                </tr>
                <tr class="blank_row">
                    <td colspan="2"></td>
                </tr>
                <tr>
                    <td>
                        <label class="data-label" id="day">Dia</label>
                        <span id='dia-field' style="font-size: 5em" class='data-field'></span>
                    </td>
                    <td>
                        <label class="data-label" id="month">Acumulado mes</label>
                        <span id='acumulado-field' style="font-size: 5em" class='data-field pct'></span>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="row centered lower shaded-background">
        <div class="col-9">
            <span class='big-label' id="horno-label"></span>
        </div>
        <div class="col-3">
            <table border="0" cellpadding="5" id="data-table">
            </table>
        </div>
    </div>
</div>
<p id="infoContainer"></p>
</body>
<script type="text/javascript">
    var prefs = new gadgets.Prefs();
    var addr = prefs.getString("serverAddr");
    var ENDPOINT = addr;
	var INTERVAL = 1 * 60 * 1000; // minutes * seconds * 1000 milliseconds
	var ROTATE_INTERVAL = 20 * 1000; // seconds * 1000 milliseconds
    var LINEAR_HORNO_ID = 0;
    var LINEAR_DATA = [];
    var LINEAR_DATA_IDX = 0;
    var timeoutId = -1;
    var ovenTxt = prefs.getString("oven");
    $('#date').html(prefs.getString("date"));
    $('#day').html(prefs.getString("day"));
    $('#mid-label').html(prefs.getString("midLabel"));
    $('#top-label').html(prefs.getString("topLabel"));
    $('#month').html(prefs.getString("month"));
    function getFile(filename, action) {
        setInfo("getting file " + filename);
        var xhr = new XMLHttpRequest();
        xhr.open("GET", ENDPOINT + "/" + filename, true);
        xhr.onload = function (e) {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    action(xhr.responseText);
                } else {
                    console.error(xhr.statusText);
                }
            }
        };
        xhr.onerror = function (e) {
            console.error(xhr.statusText);
        };
        xhr.send(null);
    }
    function processPlantData(data) {
        setInfo("processPlantData");
        var array = data.split(/\r?\n/);
        if (array.length >= 4) {
            var fechaField = document.getElementById("fecha-field");
            fechaField.innerText = array[1];
            var diaField = document.getElementById("dia-field");
            diaField.innerText = array[2];
            var acumuladoField = document.getElementById("acumulado-field");
            acumuladoField.innerText = array[3];
        }
    };
    function processLinearData(data) {
        var START = 2;
        LINEAR_DATA = [];
        var array = data.trim ().split(/\r?\n/);
        for (var i = START; i < array.length; i += 3) {
            LINEAR_DATA.push(array.slice(i,i+3));
        }

        clearInterval(timeoutId);
        displayLinearData();
        timeoutId = setInterval(displayLinearData, ROTATE_INTERVAL);
    };
    function displayLinearData() {
        try {
            var hornoIdField = document.getElementById("horno-label");
            var dataTable = $("#data-table");
            dataTable.empty();

            var floored = Math.floor(LINEAR_DATA[LINEAR_DATA_IDX][0]/10);
            var oldFloored = floored;
            hornoIdField.innerText = ovenTxt +" " + floored;
            while (floored === oldFloored) {
                var td1 = $('<td>').attr('align','center').append($('<div>').addClass('num').text(LINEAR_DATA[LINEAR_DATA_IDX][0]));
                var td2 = $('<td>').attr('align','center').append($('<div>').addClass('data-field pct').text(formatData(LINEAR_DATA[LINEAR_DATA_IDX][1])));
                var td3 = $('<td>').attr('align','center').append($('<div>').addClass('data-field pct').text(formatData(LINEAR_DATA[LINEAR_DATA_IDX][2])));
                var blank = $('<tr>').addClass('blank_row').append($('<td>').attr('colspan','3'));

                var tr = $('<tr>').append(td1).append(td2).append(td3);
                $(dataTable).append(tr).append(blank);
                LINEAR_DATA_IDX++;
                floored = Math.floor(LINEAR_DATA[LINEAR_DATA_IDX][0]/10)
            }
        } catch (e) {
            LINEAR_DATA_IDX = 0;
        }

    }

    function formatData(data){
        console.log(data.length);
        if(data.length<7){
            return data+(Array(9-data.length).join(" ").toString());
        }
        return data
    }
    function init() {
        setInfo("init gadget " + ENDPOINT);

        getFile("datosplanta.txt", processPlantData);
        setInterval(function() { getFile("datosplanta.txt", processPlantData) }, INTERVAL);

        getFile("datoslineas.txt", processLinearData);
        setInterval(function() { getFile("datoslineas.txt", processLinearData) }, INTERVAL);
    }

    gadgets.util.registerOnLoadHandler(init);
    function setInfo(data) {
        var debug = false;
        if (debug) {
            var container = $('#infoContainer');
            container.append(data + '<br>');
        }
        if (debug) {
            console.log(data);
        }
    }
</script>



]]>
</Content>
</Module>
